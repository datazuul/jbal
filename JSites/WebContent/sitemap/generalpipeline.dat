<map:pipeline>
		
	<map:match pattern="profile.html">
		<map:redirect-to uri="cocoon://profile.html"/>
	</map:match>
	
	<map:match pattern="profile.xml">
		<map:redirect-to uri="cocoon://profile.xml"/>
	</map:match>
	
	<map:match pattern="content">
		<map:redirect-to uri="cocoon://getcontent?db={global:db}"/>
	</map:match>

<!--	
	<map:match pattern="listpages">
		<map:redirect-to uri="cocoon://getlistpages?db={global:db}"/>
	</map:match>
-->
	<map:match pattern="fileManager">
		<map:act type="auth-protect">
        	<map:parameter name="handler" value="JSitesHandler"/>
        
        	<map:act type="authorize-users">
        		<map:parameter name="db" value="{global:db}"/>
        		<map:parameter name="pid" value="0"/>
				<map:generate type="fileManager" src="{global:data-directory}/images/{../../1}">
					<map:parameter name="db" value="{global:db}"/>
				</map:generate>
				<!--
				<map:act type="request">
					<map:transform src="context://stylesheets/xslt/dir2page.xslt">
						<map:parameter name="parameters" value="true"/>
						<map:parameter name="permissionCode" value="{../permissionCode}"/>
						<map:parameter name="base" value="images/{../../../1}"/>
						<map:parameter name="context" value="{context}"/>
					</map:transform>
				</map:act>
				-->
			</map:act>	
			
			<map:serialize type="xml" />
		</map:act>
	
	</map:match>
	
		<map:match pattern="dir/**">
        <map:act type="auth-protect">
        	<map:parameter name="handler" value="JSitesHandler"/>
        
        	<map:act type="authorize-users">
        		<map:parameter name="db" value="{global:db}"/>
        		<map:parameter name="pid" value="0"/>
				<map:generate type="directory" src="{global:data-directory}/images/{../../1}">
					<map:parameter name="depth" value="1"/>
					<map:parameter name="sort" value="directory"/>
				</map:generate>
				<map:act type="request">
					<map:transform src="context://stylesheets/xslt/dir2page.xslt">
						<map:parameter name="parameters" value="true"/>
						<map:parameter name="permissionCode" value="{../permissionCode}"/>
						<map:parameter name="base" value="images/{../../../1}"/>
						<map:parameter name="context" value="{context}"/>
					</map:transform>
				</map:act>
			</map:act>	
			
			<map:serialize type="xhtml" />
		</map:act>
	</map:match>

	  <map:match pattern="**/upload">
		<map:act type="auth-loggedIn">
        	<map:parameter name="handler" value="JSitesHandler"/>
	        <map:act type="auth-protect">
		        <map:parameter name="handler" value="JSitesHandler"/>
				<map:generate type="internalSave">
					<map:parameter name="db" value="{global:db}"/>
				</map:generate>
				<map:transform src="context://stylesheets/xslt/prepareCopyFile.xslt">
					<map:parameter name="components-dir" value="{global:data-directory}"/>
				</map:transform>
				<map:transform type="copyFile" />
				<map:act type="request">
					<map:transform src="context://stylesheets/xslt/redirect.xslt">
						<map:parameter name="parameters" value="true"/>
						<map:parameter name="base" value="{../../../1}"/>
						<map:parameter name="context" value="{context}"/>
					</map:transform>
				</map:act>
				<map:serialize type="xhtml"/>
			</map:act>
		</map:act>
	</map:match>

    <map:match pattern="images/jopac.jpg">
  		<map:act type="ImageDateAction" src="WEB-INF/conf/logos.lst">
    		<map:read mime-type="image/{type}" src="{global:data-directory}/{imagename}">
    			<map:parameter name="expires" value="21600000"/>  <!-- 6h, in ms -->
    		</map:read>
  		</map:act>
  		<map:serialize/>
	</map:match>
	
	<map:match pattern="*.html">
		<map:generate src="{1}.html"/>
		<map:serialize type="html"/>
   	</map:match>
   	
   	<map:match pattern="**/*.pdf">
   		<map:read mime-type="application/pdf" src="{global:data-directory}/{1}/{2}.pdf">
   		<map:parameter name="byte-ranges" value="false" />
   		<map:parameter name="buffer-size" value="163840" />
   		</map:read>
   	</map:match>
	
	<map:match pattern="images/**">
       	<map:read src="{global:data-directory}/images/{1}" />
   	</map:match>
   	
   	<map:match pattern="css/*.css">
       	<map:read mime-type="text/css" src="css/{1}.css" />
   	</map:match>

<!--
   	<map:match pattern="js/*.js">
       	<map:read mime-type="text/js" src="../js/{1}.js" />
   	</map:match>


   	<map:match pattern="js/**/*.*">
       	<map:read src="../js/{1}/{2}.{3}" />
   	</map:match>
-->
	<map:match pattern="js/**">
       	<map:read src="../js/{1}" />
   	</map:match>

	<map:match pattern="">
		<map:redirect-to uri="cocoon:/pageview?pid=1&amp;lang=it" />
    </map:match>

    <map:match pattern="/">
		<map:redirect-to uri="cocoon:/pageview?pid=1&amp;lang=it" />
    </map:match>
    
	<map:match pattern="*">
        <map:redirect-to uri="pageview?pcode={1}"/>
    </map:match>
    
    <map:match pattern="*/">
        <map:redirect-to uri="../pageview?pcode={1}"/>
    </map:match>
    
	<map:match pattern="*_components/**">
		<map:read src="/{1}_components/{2}"/>
	</map:match>
    
		    
</map:pipeline>

<map:pipeline internal-only="true">
	<map:match pattern="*/**">
		<map:mount check-reload="yes" src="context://{1}/" uri-prefix="{1}" />
	</map:match>
</map:pipeline>